version: '3.7'

services:

  tekana-customer-svc:
    image: "tekana-customer-svc:dev"
    build:
      context: "./microservices/tekana-customer-svc"
    depends_on:
      - "postgres_db"

  tekana-wallet-svc:
    image: "tekana-wallet-svc:dev"
    build:
      context: "./microservices/tekana-wallet-svc"
    depends_on:
      - "postgres_db"

  tekana-transaction-svc:
    image: "tekana-transaction-svc:dev"
    build:
      context: "./microservices/tekana-transaction-svc"
    depends_on:
      - "postgres_db"

  tekana-api-gateway:
    image: "tekana-api-gateway:dev"
    build:
      context: "./tekana-api-gateway"
    depends_on:
      - "tekana-transaction-svc"
      - "tekana-wallet-svc"
      - "tekana-customer-svc"

  swagger-ui:
    image: "swaggerapi/swagger-ui:v3.25.0"
    ports:
      - "8080:8080"
    volumes:
      - "./docs/openapi-spec.yaml:/usr/share/spec/openapi-spec.yaml"
    environment:
      SWAGGER_JSON: "/usr/share/spec/openapi-spec.yaml"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "localhost:8080 -q -O - > /dev/null 2>&1"
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres_db:
    image: "postgres:12.1-alpine"
    expose:
      - "5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: '12345'
      POSTGRES_DB: customer_db wallet_db transaction_db
    healthcheck:
      test: [ "CMD-SHELL", "su -c 'pg_isready -U postgres' 12345" ]
      interval: 30s
      timeout: 30s
      retries: 3
    restart: "on-failure"
    ports:
      - "5432:5432"
